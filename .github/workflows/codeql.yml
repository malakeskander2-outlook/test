name: Regex Security Scan Before Merge

on:
  pull_request:
    branches:
      - production
      - main

jobs:
  regex_scan:
    runs-on: ubuntu-latest
    name: Malicious Pattern Detection
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Scan for suspicious code
        id: scan
        run: |
          echo "Scanning for suspicious code patterns..."
          MALICIOUS=$(grep -R -n -E "(eval\(|exec\(|os.system|subprocess.call|shell_exec|base64_decode|curl|wget|powershell|Invoke-Expression)" . || true)
          if [ ! -z "$MALICIOUS" ]; then
            echo "❌ Malicious patterns detected:"
            echo "$MALICIOUS"
            echo "found=true" >> $GITHUB_OUTPUT
          else
            echo "✅ No malicious patterns found."
            echo "found=false" >> $GITHUB_OUTPUT
          fi

      - name: Send alert email
        if: steps.scan.outputs.found == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USER }}
          password: ${{ secrets.EMAIL_PASS }}
          subject: "🚨 Malicious Code Detected in PR #${{ github.event.pull_request.number }}"
          body: |
            Suspicious code detected in:
            ${{ github.event.pull_request.html_url }}
            ---
            $MALICIOUS
          to: "security-team@example.com"
          from: "github-bot@example.com"

      - name: Block merge
        if: steps.scan.outputs.found == 'true'
        run: |
          echo "Merge blocked due to detected malicious patterns."
          exit 1

  approve:
    name: Manual Approval for Production Merge
    needs: regex_scan
    if: needs.regex_scan.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Wait for manual approval
        uses: trstringer/manual-approval@v1
        with:
          approvers: malak@example.com,securitylead@example.com
          secret: ${{ secrets.GITHUB_TOKEN }}
