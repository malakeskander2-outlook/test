name: Semgrep Security Scan Before Merge

on:
  pull_request:
    branches:
      - production
      - main

jobs:
  security_scan:
    runs-on: ubuntu-latest
    name: Semgrep Malicious Code Scan
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Semgrep
        run: |
          pip install semgrep

      - name: Run Semgrep Security Rules
        id: semgrep
        run: |
          echo "üîç Running Semgrep security analysis..."
          semgrep --config p/ci --json --output semgrep-report.json || true
          
          # Detect findings
          ISSUE_COUNT=$(jq '.results | length' semgrep-report.json)
          echo "issue_count=$ISSUE_COUNT" >> $GITHUB_OUTPUT

      - name: Send Email Notification (if issues found)
        if: steps.semgrep.outputs.issue_count != '0'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USER }}
          password: ${{ secrets.EMAIL_PASS }}
          subject: "üö® Semgrep Security Findings in PR #${{ github.event.pull_request.number }}"
          body: |
            Semgrep detected potential malicious or insecure code.
            PR Link: ${{ github.event.pull_request.html_url }}
            Number of findings: ${{ steps.semgrep.outputs.issue_count }}
          to: "security-team@example.com"
          from: "github-bot@example.com"
        continue-on-error: true

      - name: Fail if issues found
        if: steps.semgrep.outputs.issue_count != '0'
        run: |
          echo "‚ùå Malicious or insecure code detected. Merge blocked."
          exit 1

  approval:
    name: Manual Approval for Production Merge
    needs: security_scan
    if: needs.security_scan.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Wait for manual approval
        uses: trstringer/manual-approval@v1
        with:
          approvers: malak@example.com,securitylead@example.com
          secret: ${{ secrets.GITHUB_TOKEN }}
